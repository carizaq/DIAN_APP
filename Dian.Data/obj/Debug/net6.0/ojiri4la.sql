IF OBJECT_ID(N'[__EFMigrationsHistory]') IS NULL
BEGIN
    CREATE TABLE [__EFMigrationsHistory] (
        [MigrationId] nvarchar(150) NOT NULL,
        [ProductVersion] nvarchar(32) NOT NULL,
        CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
    );
END;
GO

BEGIN TRANSACTION;
GO

CREATE TABLE [TL_CLIENTES] (
    [IdCliente] int NOT NULL IDENTITY,
    [NOM_CLIENTE] nvarchar(300) NOT NULL,
    [NUM_TELEFONO] bigint NOT NULL,
    [NOM_DIRECCION] nvarchar(20) NOT NULL,
    [FEC_INGRESO] date NOT NULL,
    [COD_ESTRATO] smallint NOT NULL,
    CONSTRAINT [PK_TL_CLIENTES] PRIMARY KEY ([IdCliente])
);
GO

CREATE TABLE [TL_PRODUCTOS] (
    [IDProducto] int NOT NULL IDENTITY,
    [NOM_PRODUCTO] nvarchar(20) NOT NULL,
    [VAL_UNITARIO] decimal(10,0) NOT NULL,
    [NUM_UNIDADES_DISPONIBLES] int NOT NULL,
    [FEC_INGRESO] date NOT NULL,
    CONSTRAINT [PK_TL_PRODUCTOS] PRIMARY KEY ([IDProducto])
);
GO

CREATE TABLE [TL_TIPOS_TARJETA_CREDITO] (
    [IDE_TIPO_TARJETA] smallint NOT NULL IDENTITY,
    [NOM_TIPO_TARJETA] nvarchar(50) NOT NULL,
    CONSTRAINT [PK_TL_TIPOS_TARJETA_CREDITO] PRIMARY KEY ([IDE_TIPO_TARJETA])
);
GO

CREATE TABLE [TL_FACTURAS] (
    [IdFactura] int NOT NULL IDENTITY,
    [FEC_FACTURA] date NOT NULL,
    [IDE_CLIENTE] int NOT NULL,
    [VAL_FACTURA] decimal(15,0) NOT NULL,
    [COD_TIPO_PAGO] int NOT NULL,
    [IDE_TIPO_TARJETA] smallint NOT NULL,
    CONSTRAINT [PK_TL_FACTURAS] PRIMARY KEY ([IdFactura]),
    CONSTRAINT [FACT_CLIE_FK] FOREIGN KEY ([IDE_CLIENTE]) REFERENCES [TL_CLIENTES] ([IdCliente]) ON DELETE CASCADE,
    CONSTRAINT [FACT_TITC_FK] FOREIGN KEY ([IDE_TIPO_TARJETA]) REFERENCES [TL_TIPOS_TARJETA_CREDITO] ([IDE_TIPO_TARJETA]) ON DELETE CASCADE
);
GO

CREATE TABLE [TL_DETALLES_FACTURAS] (
    [IDE_FACTURA] int NOT NULL,
    [IDE_PRODUCTO] int NOT NULL,
    [NUM_UNIDADES] int NOT NULL,
    [VAL_SUBTOTAL] decimal(22,0) NOT NULL,
    CONSTRAINT [PK_TL_DETALLES_FACTURAS] PRIMARY KEY ([IDE_FACTURA], [IDE_PRODUCTO]),
    CONSTRAINT [DEFA_FACT_FK] FOREIGN KEY ([IDE_FACTURA]) REFERENCES [TL_FACTURAS] ([IdFactura]) ON DELETE CASCADE,
    CONSTRAINT [DEFA_PROD_FK] FOREIGN KEY ([IDE_FACTURA]) REFERENCES [TL_PRODUCTOS] ([IDProducto]) ON DELETE CASCADE
);
GO

CREATE INDEX [IX_TL_FACTURAS_IDE_CLIENTE] ON [TL_FACTURAS] ([IDE_CLIENTE]);
GO

CREATE INDEX [IX_TL_FACTURAS_IDE_TIPO_TARJETA] ON [TL_FACTURAS] ([IDE_TIPO_TARJETA]);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20240408024636_Migracion_Base', N'7.0.17');
GO

COMMIT;
GO

